 url=https://github.com/Avalianfeng/matrix-manage/blob/main/.github/workflows/github_workflows_cross-platform-release.yml
on:
  push:
    tags:
      - 'v*'       # 仅推送 tag 时发布 release
  workflow_dispatch: # 允许手动触发

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: Configure & build (MSVC)
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build --config Release
    - name: List build output (Windows)
      run: |
        echo "Listing build directory:"
        dir build
        echo "Listing build/bin directory:"
        dir build\bin || echo "build\bin not found"
        echo "Listing build/Release directory (VS default):"
        dir build\Release || echo "build\Release not found"
    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: matrix-manage-windows
        path: |
          build/bin/*
          build/Release/*.exe

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - name: Configure & build (macOS)
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build --config Release
    - name: List build output (macOS)
      run: |
        echo "Listing build directory:"
        ls -la build || true
        echo "Listing build/bin directory:"
        ls -la build/bin || true
    - name: Upload macOS Artifact
      uses: actions/upload-artifact@v4
      with:
        name: matrix-manage-macos
        path: build/bin/*

  release:
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos]
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    - name: List downloaded artifacts
      run: |
        echo "Artifacts root:"
        ls -R artifacts || true
    - name: Prepare Release Artifacts
      run: |
        mkdir -p release
        # 尝试拷贝各平台产物到 release/，若某个不存在则继续
        if [ -d artifacts/matrix-manage-windows ]; then
          cp artifacts/matrix-manage-windows/* release/ || true
        fi
        if [ -d artifacts/matrix-manage-macos ]; then
          cp artifacts/matrix-manage-macos/* release/ || true
        fi
        echo "Final release dir:"
        ls -la release || true
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: release/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
